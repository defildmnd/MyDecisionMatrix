<!DOCTYPE html><html lang="de"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Easy Decision by Sven</title><style>  :root {    --bg: #0f1116;    --bg-elev: #151926;    --panel: #1b2134;    --panel-2: #222a42;    --text: #e6e9f2;    --muted: #a7b0c3;    --accent: #5bc0de;    --accent-2: #88e0a7;    --danger: #ff6b6b;    --warning: #ffcc66;    --ok: #7bd389;    --border: #2d3550;    --shadow: 0 8px 24px rgba(0,0,0,0.35);    --radius: 12px;    --radius-sm: 8px;    --focus: 0 0 0 3px rgba(91,192,222,0.35);    --slider-pos: #35c759;   /* positiv */    --slider-neg: #ff3b30;   /* negativ */    --slider-zero: #8892a7;  /* neutral */    --step-done: #2e7dff;  }  * { box-sizing: border-box; }  html, body {    margin: 0; padding: 0; background: var(--bg); color: var(--text);    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;  }  header {    background: linear-gradient(135deg, #0f1116 0%, #121625 60%, #161b2b 100%);    border-bottom: 1px solid var(--border);    position: sticky; top: 0; z-index: 10;  }  .head-wrap {    max-width: 1200px; margin: 0 auto; padding: 18px 20px; display: flex; align-items: center; gap: 16px; justify-content: space-between;  }  .brand {    display: flex; align-items: center; gap: 14px;  }  .logo {    width: 40px; height: 40px; border-radius: 50%;    background: radial-gradient(circle at 30% 30%, var(--accent-2), var(--accent));    box-shadow: 0 0 20px rgba(91,192,222,0.3);  }  .title {    line-height: 1.1;  }  .title h1 {    margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.2px;  }  .title small {    display: block; color: var(--muted); margin-top: 2px;  }  .actions {    display: flex; gap: 8px; flex-wrap: wrap; align-items: center;  }  button, .btn {    background: var(--panel); color: var(--text); border: 1px solid var(--border);    padding: 10px 14px; border-radius: var(--radius-sm); cursor: pointer;    box-shadow: var(--shadow); transition: transform .05s ease, background .15s ease, border-color .15s ease, opacity .15s ease;  }  button:hover, .btn:hover { background: var(--panel-2); }  button:active, .btn:active { transform: translateY(1px); }  button.primary { background: #2155ff; border-color: #1e46c9; }  button.primary:hover { background: #1d4be6; }  button.ghost { background: transparent; border-color: var(--border); }  button.danger { background: #7e1e2a; border-color: #982938; }  button.danger:hover { background: #922434; }  button:disabled { opacity: 0.5; cursor: not-allowed; }  .file-input { position: relative; overflow: hidden; display: inline-block; }  .file-input input[type="file"] {    position: absolute; left: 0; top: 0; width: 100%; height: 100%;    opacity: 0; cursor: pointer;  }  .stepper {    max-width: 1200px; margin: 8px auto 0; padding: 0 20px 16px;    display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;  }  .step {    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-sm);    padding: 8px 10px; text-align: center; color: var(--muted); position: relative;  }  .step.active { color: var(--text); border-color: var(--step-done); box-shadow: 0 0 0 2px rgba(46,125,255,0.2) inset; }  .step.done { color: #bcd0ff; border-color: #27407d; }  .step span.num {    display: inline-flex; width: 22px; height: 22px; border-radius: 50%;    align-items: center; justify-content: center; font-size: 12px;    background: var(--panel-2); margin-right: 6px; color: var(--text);  }  .step.active span.num { background: var(--step-done); }  .step.done span.num { background: #27407d; }  main { max-width: 1200px; margin: 18px auto; padding: 0 20px 40px; }  .panel {    background: var(--bg-elev); border: 1px solid var(--border); border-radius: var(--radius);    padding: 18px; box-shadow: var(--shadow);  }  h2 { margin: 0 0 14px; font-size: 18px; }  p.note { margin-top: -6px; color: var(--muted); }  .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }  .row + .row { margin-top: 10px; }  .list { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }  .item {    display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: center;    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px;  }  .item.single {    grid-template-columns: 1fr auto;  }  .item .stack { display: flex; flex-direction: column; gap: 6px; }  input[type="text"], input[type="number"] {    width: 100%; padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border);    background: #111524; color: var(--text); outline: none;  }  input[type="text"]::placeholder { color: #6b748a; }  input[type="number"] { width: 90px; }  textarea { width: 100%; min-height: 70px; }  .slider {    display: grid; grid-template-columns: 1fr 90px; gap: 10px; align-items: center;  }  input[type="range"] {    -webkit-appearance: none; appearance: none; height: 6px; border-radius: 999px; background: linear-gradient(90deg, var(--slider-neg), var(--slider-zero) 50%, var(--slider-pos) 100%);    outline: none; border: 1px solid var(--border);  }  input[type="range"]::-webkit-slider-thumb {    -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;    background: #f8fafc; border: 2px solid #2b3553; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.35);  }  input[type="range"]::-moz-range-thumb {    width: 18px; height: 18px; border-radius: 50%; background: #f8fafc; border: 2px solid #2b3553; cursor: pointer;  }  .grid {    display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));  }  .card {    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius);    padding: 14px; box-shadow: var(--shadow);  }  .card h3 { margin: 0 0 10px; font-size: 16px; }  .card .sub { color: var(--muted); font-size: 12px; margin-top: -4px; margin-bottom: 8px; }  .card .line { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 8px 0; }  .card .line label { color: var(--muted); }  .card .line .slider { grid-template-columns: 1fr 70px; }  .card .top-actions { display: flex; gap: 8px; margin-bottom: 8px; }  .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 10px; }  .toolbar .left, .toolbar .right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }  .badge {    display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px;    border-radius: 999px; background: var(--panel); border: 1px solid var(--border); color: var(--muted);  }  .footer-nav {    display: flex; gap: 10px; justify-content: space-between; margin-top: 16px;  }  .warn {    padding: 10px 12px; border: 1px solid var(--border); background: #2a1a1a; color: #ffd6d6;    border-radius: var(--radius-sm); margin: 8px 0 0;  }  .info {    padding: 10px 12px; border: 1px solid var(--border); background: #1a2431; color: #d1e8ff;    border-radius: var(--radius-sm); margin: 8px 0 0;  }  .rank {    display: grid; grid-template-columns: 60px 1fr 120px; gap: 10px; align-items: center;    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px;  }  .rank + .rank { margin-top: 8px; }  .mini-bar {    height: 10px; background: #111524; border: 1px solid var(--border); border-radius: 999px; position: relative; overflow: hidden;  }  .mini-bar .fill { position: absolute; top: 0; bottom: 0; background: linear-gradient(90deg, #ff4d4d, #66ff99); }  .score-pill {    text-align: right; color: var(--text);  }  .tabs { display: flex; gap: 8px; margin-bottom: 10px; }  .tab { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: var(--panel); color: var(--muted); cursor: pointer; }  .tab.active { color: var(--text); border-color: var(--accent); box-shadow: 0 0 0 2px rgba(91,192,222,0.25) inset; }  .chart {    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; overflow: hidden;  }  .legend { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; color: var(--muted); }  .legend .key { display: inline-flex; align-items: center; gap: 6px; }  .legend .swatch { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }  .hidden { display: none !important; }  .hint {    color: var(--muted); font-size: 12px; margin-top: 8px;  }  @media (max-width: 640px) {    .rank { grid-template-columns: 40px 1fr 90px; }    .stepper { grid-template-columns: 1fr; }  }</style></head><body><header>  <div class="head-wrap">    <div class="brand">      <div class="logo" aria-hidden="true"></div>      <div class="title">        <h1>Easy Decision by Sven</h1>        <small>Gewichtete Entscheidungs¬≠matrix (‚àí10 ‚Ä¶ +10) ¬∑ Single-File ¬∑ Dark Mode</small>      </div>    </div>    <div class="actions">      <button class="ghost" id="btn-undo" title="Letzte Aktion r√ºckg√§ngig (ein Schritt)">‚Ü∂ R√ºckg√§ngig</button>      <button id="btn-reset" class="danger" title="Alles zur√ºcksetzen (Neu)">Neu</button>      <button id="btn-export" class="btn">Export</button>      <label class="file-input btn">        Import        <input type="file" id="file-import" accept="application/json" />      </label>      <button id="btn-print" class="btn">Drucken</button>    </div>  </div>  <div class="stepper" id="stepper">    <div class="step active" data-step="1"><span class="num">1</span>Kriterien</div>    <div class="step" data-step="2"><span class="num">2</span>Gewichte</div>    <div class="step" data-step="3"><span class="num">3</span>Optionen</div>    <div class="step" data-step="4"><span class="num">4</span>Bewertungen</div>    <div class="step" data-step="5"><span class="num">5</span>Auswertung</div>  </div></header><main>  <!-- STEP 1: Kriterien -->  <section id="step-1" class="panel">    <h2>Schritt 1 ‚Äì Kriterien anlegen</h2>    <p class="note">Lege die Kriterien fest (z.‚ÄØB. Preis, Qualit√§t, Risiko). Beschreibung ist optional. Du brauchst mindestens ein Kriterium.</p>    <div class="row">      <input id="crit-name" type="text" placeholder="Kriterienname (z.‚ÄØB. Preis)" aria-label="Kriterienname" />      <button id="add-crit">+ Kriterium hinzuf√ºgen</button>    </div>    <div class="row">      <input id="crit-desc" type="text" placeholder="Beschreibung (optional, z.‚ÄØB. niedriger ist besser)" aria-label="Kriterienbeschreibung" />      <span class="hint">Tipp: ENTER f√ºgt hinzu ¬∑ STRG+ENTER f√ºgt hinzu und leert die Felder</span>    </div>    <div id="crit-list" class="list" aria-live="polite"></div>    <div id="crit-empty" class="info">Noch keine Kriterien. F√ºge oben dein erstes Kriterium hinzu.</div>    <div class="footer-nav">      <div>        <!-- Platzhalter links -->      </div>      <div>        <button id="to-2" class="primary" disabled>Weiter: Gewichte ‚Üí</button>      </div>    </div>  </section>  <!-- STEP 2: Gewichte -->  <section id="step-2" class="panel hidden">    <h2>Schritt 2 ‚Äì Kriterien gewichten (‚àí10 ‚Ä¶ +10)</h2>    <p class="note">0 = neutral ¬∑ +10 = stark positiv (maximieren) ¬∑ ‚àí10 = stark negativ (minimieren). Gewichte werden mit Betr√§gen normiert, Vorzeichen bleibt erhalten.</p>    <div id="weight-summary" class="badge">Œ£ |Gewichte|: <strong id="sumW">0</strong></div>    <div id="weights-list" class="list" aria-live="polite"></div>    <div id="weights-empty" class="warn hidden">Es gibt noch keine Kriterien. Bitte gehe zur√ºck und lege mindestens ein Kriterium an.</div>    <div class="toolbar">      <div class="left">        <button id="weights-zero" class="btn">Alle Gewichte auf 0</button>      </div>      <div class="right">        <span class="hint">Du kannst Kriterien auch hier l√∂schen.</span>      </div>    </div>    <div class="footer-nav">      <div>        <button id="back-1" class="ghost">‚Üê Zur√ºck</button>      </div>      <div>        <button id="to-3" class="primary" disabled>Weiter: Optionen ‚Üí</button>      </div>    </div>  </section>  <!-- STEP 3: Optionen -->  <section id="step-3" class="panel hidden">    <h2>Schritt 3 ‚Äì Optionen anlegen</h2>    <p class="note">Lege die Alternativen fest (z.‚ÄØB. Anbieter A/B/C). Mindestens eine Option ist notwendig.</p>    <div class="row">      <input id="opt-name" type="text" placeholder="Optionsname (z.‚ÄØB. Anbieter A)" aria-label="Optionsname" />      <button id="add-opt">+ Option hinzuf√ºgen</button>    </div>    <div id="opt-list" class="list" aria-live="polite"></div>    <div id="opt-empty" class="info">Noch keine Optionen. F√ºge oben deine erste Option hinzu.</div>    <div class="footer-nav">      <div>        <button id="back-2" class="ghost">‚Üê Zur√ºck</button>      </div>      <div>        <button id="to-4" class="primary" disabled>Weiter: Bewertungen ‚Üí</button>      </div>    </div>  </section>  <!-- STEP 4: Bewertungen -->  <section id="step-4" class="panel hidden">    <h2>Schritt 4 ‚Äì Bewertungen je Option/Kriterium (‚àí10 ‚Ä¶ +10)</h2>    <p class="note">Bewerte jede Option anhand der Kriterien. 0 = neutral. Skala ‚àí10 ‚Ä¶ +10.</p>    <div class="toolbar">      <div class="left">        <button id="ratings-zero" class="btn">Alle Bewertungen auf 0</button>      </div>      <div class="right">        <button id="to-5-top" class="primary">Weiter zur Auswertung ‚Üí</button>      </div>    </div>    <div id="ratings-grid" class="grid"></div>    <div id="ratings-empty" class="warn hidden">Es fehlen Kriterien oder Optionen. Bitte lege beides an.</div>    <div class="footer-nav">      <div>        <button id="back-3" class="ghost">‚Üê Zur√ºck</button>      </div>      <div>        <button id="to-5" class="primary">Weiter: Auswertung ‚Üí</button>      </div>    </div>  </section>  <!-- STEP 5: Auswertung -->  <section id="step-5" class="panel hidden">    <h2>Schritt 5 ‚Äì Auswertung & Ranking</h2>    <div id="weights-zero-banner" class="warn hidden">Hinweis: Alle Gewichte sind 0 ‚Äì daher sind alle Gesamtscores 0. Bitte passe Gewichte an.</div>    <div id="ranking" class="list" aria-live="polite"></div>    <div style="height: 12px;"></div>    <div class="tabs">      <div class="tab active" data-tab="total">Gesamt-Score</div>      <div class="tab" data-tab="stacked">Beitragsanalyse (gestapelt)</div>    </div>    <div id="chart-area" class="chart">      <!-- SVG Charts werden hier gerendert -->    </div>    <div id="legend" class="legend"></div>    <div class="toolbar">      <div class="left">        <button id="back-4" class="ghost">‚Üê Zur√ºck zu Bewertungen</button>      </div>      <div class="right">        <button id="goto-weights" class="btn">Gewichte √§ndern</button>        <button id="goto-options" class="btn">Optionen √§ndern</button>        <button id="btn-export-2" class="btn">Export</button>      </div>    </div>  </section></main><script>/** ========================= *  Easy Decision by Sven *  Single-File, Vanilla JS *  ========================= */(function(){  const el = sel => document.querySelector(sel);  const els = sel => Array.from(document.querySelectorAll(sel));  const deepClone = (obj) => JSON.parse(JSON.stringify(obj));  const genId = (p='id') => p + '_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4);  /** ---- State ---- **/  let state = {    criteria: [],    options: [],    ratings: {}, // ratings[optionId][criterionId] = -10..10    ui: { step: 1, chartTab: 'total' },    meta: { version: 1 }  };  let lastState = null; // f√ºr ein Schritt R√ºckg√§ngig  /** ---- Persistence ---- **/  const STORAGE_KEY = 'wdm_state_sven';  function saveState() {    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));  }  function loadState() {    const raw = localStorage.getItem(STORAGE_KEY);    if (!raw) return false;    try {      const parsed = JSON.parse(raw);      if (parsed && parsed.meta && parsed.meta.version >= 1) {        state = parsed;        return true;      }    } catch(e) { console.warn('Load state failed', e); }    return false;  }  function snapshot() { lastState = deepClone(state); }  function undo() {    if (!lastState) return;    const cur = deepClone(state);    state = lastState;    lastState = cur;    saveState();    renderAll();  }  /** ---- Utilities ---- **/  function ensureRatingsForOption(optionId) {    if (!state.ratings[optionId]) state.ratings[optionId] = {};    for (const c of state.criteria) {      if (typeof state.ratings[optionId][c.id] !== 'number') state.ratings[optionId][c.id] = 0;    }  }  function ensureRatingsForCriterion(criterionId) {    for (const o of state.options) {      if (!state.ratings[o.id]) state.ratings[o.id] = {};      if (typeof state.ratings[o.id][criterionId] !== 'number') state.ratings[o.id][criterionId] = 0;    }  }  function removeCriterionEverywhere(criterionId) {    for (const o of state.options) {      if (state.ratings[o.id]) delete state.ratings[o.id][criterionId];    }  }  function removeOptionEverywhere(optionId) {    delete state.ratings[optionId];  }  function sumAbsWeights() {    return state.criteria.reduce((acc, c) => acc + Math.abs(Number(c.weight||0)), 0);  }  function normalizedWeights() {    const W = sumAbsWeights();    const map = {};    if (W === 0) {      for (const c of state.criteria) map[c.id] = 0;      return { W, map };    }    for (const c of state.criteria) {      map[c.id] = (Number(c.weight)||0) / W;    }    return { W, map };  }  function computeScores() {    const { W, map: wNorm } = normalizedWeights();    const scores = {};    for (const o of state.options) {      let s = 0;      for (const c of state.criteria) {        const r = (state.ratings[o.id] && typeof state.ratings[o.id][c.id] === 'number') ? state.ratings[o.id][c.id] : 0;        s += wNorm[c.id] * r;      }      scores[o.id] = s; // Bereich ungef√§hr ‚àí10..+10    }    return { W, wNorm, scores };  }  function computeContributions() {    const { W, map: wNorm } = normalizedWeights();    const contrib = {}; // contrib[optionId] = [{criterionId, value}]    for (const o of state.options) {      contrib[o.id] = state.criteria.map(c => {        const r = (state.ratings[o.id] && typeof state.ratings[o.id][c.id] === 'number') ? state.ratings[o.id][c.id] : 0;        return { criterionId: c.id, value: wNorm[c.id] * r };      });    }    return { W, wNorm, contrib };  }  /** ---- Stepper Navigation ---- **/  function setActiveStepIndicator() {    const s = state.ui.step;    els('.stepper .step').forEach((node, idx) => {      node.classList.remove('active', 'done');      const stepNo = idx+1;      if (stepNo === s) node.classList.add('active');      if (stepNo < s) node.classList.add('done');    });  }  function validateForStep(step) {    if (step === 2) {      return state.criteria.length > 0;    }    if (step === 3) {      return state.criteria.length > 0; // um weiterzugehen ist 2 valid, aber 3 darf betreten werden    }    if (step === 4) {      return state.criteria.length > 0 && state.options.length > 0;    }    if (step === 5) {      return state.criteria.length > 0 && state.options.length > 0;    }    return true;  }  function canGoTo(step) {    // erlaubt zur√ºck jederzeit; vorw√§rts nur wenn vorherige valid    if (step < state.ui.step) return true;    for (let s = 1; s <= step; s++) {      if (!validateForStep(s)) return false;    }    return true;  }  function gotoStep(step) {    if (!canGoTo(step)) return;    state.ui.step = step;    saveState();    renderAll();    window.scrollTo({ top: 0, behavior: 'smooth' });  }  /** ---- Rendering Root ---- **/  function renderAll() {    setActiveStepIndicator();    // Toggle Sections    for (let i=1;i<=5;i++) {      const sec = el('#step-'+i);      if (sec) sec.classList.toggle('hidden', state.ui.step !== i);    }    // Step-specific renders    renderStep1();    renderStep2();    renderStep3();    renderStep4();    renderStep5();    // Enable next buttons by validation    el('#to-2').disabled = state.criteria.length === 0;    el('#to-3').disabled = state.criteria.length === 0;    el('#to-4').disabled = !(state.criteria.length > 0 && state.options.length > 0);    // step 4 next always available if valid; already guarded above  }  /** ---- STEP 1: Criteria ---- **/  function renderStep1() {    if (state.ui.step !== 1) return;    const list = el('#crit-list');    list.innerHTML = '';    if (state.criteria.length === 0) {      el('#crit-empty').classList.remove('hidden');    } else {      el('#crit-empty').classList.add('hidden');    }    for (const c of state.criteria) {      const row = document.createElement('div');      row.className = 'item';      row.innerHTML = `        <input type="text" class="crit-name" data-id="${c.id}" value="${escapeHtml(c.name||'')}" placeholder="Name" aria-label="Kriterienname bearbeiten">        <input type="text" class="crit-desc" data-id="${c.id}" value="${escapeHtml(c.description||'')}" placeholder="Beschreibung (optional)" aria-label="Kriterienbeschreibung bearbeiten">        <div style="display:flex;gap:8px;justify-content:flex-end">          <button class="btn danger del-crit" data-id="${c.id}" title="Kriterium l√∂schen">üóëÔ∏è</button>        </div>      `;      list.appendChild(row);    }  }  /** ---- STEP 2: Weights ---- **/  function renderStep2() {    if (state.ui.step !== 2) return;    const list = el('#weights-list');    list.innerHTML = '';    const has = state.criteria.length > 0;    el('#weights-empty').classList.toggle('hidden', has);    el('#sumW').textContent = String(sumAbsWeights().toFixed(0));    for (const c of state.criteria) {      const val = Number(c.weight||0);      const row = document.createElement('div');      row.className = 'item';      row.innerHTML = `        <div class="stack">          <strong>${escapeHtml(c.name||'')}</strong>          <small style="color:var(--muted)">${escapeHtml(c.description||'')}</small>        </div>        <div class="slider">          <input type="range" min="-10" max="10" step="1" value="${val}" class="w-slider" data-id="${c.id}" aria-label="Gewicht f√ºr ${escapeHtml(c.name||'Kriterium')}">          <input type="number" min="-10" max="10" step="1" value="${val}" class="w-input" data-id="${c.id}" aria-label="Zahleneingabe Gewicht f√ºr ${escapeHtml(c.name||'Kriterium')}">        </div>        <div style="display:flex;gap:8px;justify-content:flex-end">          <button class="btn" data-action="w-zero" data-id="${c.id}" title="Gewicht auf 0" title="Kriterium l√∂schen">üóëÔ∏è</button>        </div>      `;      list.appendChild(row);    }  }  /** ---- STEP 3: Options ---- **/  function renderStep3() {    if (state.ui.step !== 3) return;    const list = el('#opt-list');    list.innerHTML = '';    if (state.options.length === 0) {      el('#opt-empty').classList.remove('hidden');    } else {      el('#opt-empty').classList.add('hidden');    }    for (const o of state.options) {      const row = document.createElement('div');      row.className = 'item single';      row.innerHTML = `        <input type="text" class="opt-name" data-id="${o.id}" value="${escapeHtml(o.name||'')}" placeholder="Optionsname" aria-label="Optionsname bearbeiten">        <div style="display:flex;gap:8px;justify-content:flex-end">          <button class="btn danger del-opt" data-id="${o.id}" title="Option l√∂schen">üóëÔ∏è</button>        </div>      `;      list.appendChild(row);    }  }  /** ---- STEP 4: Ratings ---- **/  function renderStep4() {    if (state.ui.step !== 4) return;    const grid = el('#ratings-grid');    grid.innerHTML = '';    const ok = state.criteria.length > 0 && state.options.length > 0;    el('#ratings-empty').classList.toggle('hidden', ok);    if (!ok) return;    for (const o of state.options) {      ensureRatingsForOption(o.id);      const card = document.createElement('div');      card.className = 'card';      card.innerHTML = `        <h3>${escapeHtml(o.name||'Option')}</h3>        <div class="sub">Bewertungen f√ºr alle Kriterien (‚àí10 ‚Ä¶ +10)</div>        <div class="top-actions">          <button class="btn" data-action="opt-zero" data-id <button class="btn danger del-opt" data-id="${o.id}" title="Option l√∂schen">üóëÔ∏è Option l√∂schen</button>        </div>        <div class="lines"></div>      `;      const lines = card.querySelector('.lines');      for (const c of state.criteria) {        const val = Number(state.ratings[o.id][c.id] || 0);        const line = document.createElement('div');        line.className = 'line';        line.innerHTML = `          <label title="${escapeHtml(c.description||'')}">${escapeHtml(c.name||'Kriterium')}</label>          <div class="slider">            <input type="range" min="-10" max="10" step="1" value="${val}" class="r-slider" data-oid="${o.id}" data-cid="${c.id}" aria-label="Bewertung ${escapeHtml(o.name||'Option')} f√ºr ${escapeHtml(c.name||'Kriterium')}">            <input type="number" min="-10" max="10" step="1" value="${val}" class="r-input" data-oid="${o.id}" data-cid="${c.id}" aria-label="Zahleneingabe Bewertung">          </div>        `;        lines.appendChild(line);      }      grid.appendChild(card);    }  }  /** ---- STEP 5: Evaluation ---- **/  function renderStep5() {    if (state.ui.step !== 5) return;    const { W, scores } = computeScores();    el('#weights-zero-banner').classList.toggle('hidden', W !== 0);    // Ranking    const ranking = el('#ranking');    ranking.innerHTML = '';    const items = state.options.map(o => ({ id: o.id, name: o.name, score: scores[o.id] || 0 }));    items.sort((a,b) => (b.score - a.score) || a.name.localeCompare(b.name));    const maxAbs = Math.max(10, ...items.map(it => Math.abs(it.score)));    items.forEach((it, idx) => {      const pct = (Math.abs(it.score) / maxAbs) * 100;      const fillLeft = it.score < 0; // we'll just fill from left with gradient; visual is approximate      const row = document.createElement('div');      row.className = 'rank';      row.innerHTML = `        <div><strong>#${idx+1}</strong></div>        <div>          <div>${escapeHtml(it.name||'Option')}</div>          <div class="mini-bar" title="Score: ${it.score.toFixed(3)}">            <div class="fill" style="width:${pct}%; left:${fillLeft?0:0};"></div>          </div>        </div>        <div class="score-pill"><strong>${it.score.toFixed(3)}</strong></div>      `;      ranking.appendChild(row);    });    // Charts    renderCharts();  }  /** ---- Charts (SVG) ---- **/  function renderCharts() {    const area = el('#chart-area');    area.innerHTML = ''; // clear    const tab = state.ui.chartTab || 'total';    const { scores } = computeScores();    const { contrib } = computeContributions();    if (tab === 'total') {      const rows = state.options.map(o => ({ id:o.id, name:o.name||'Option', score: scores[o.id]||0 }));      renderTotalChart(area, rows);      el('#legend').innerHTML = ''; // no legend needed    } else {      // Stacked contributions by criteria      const critColors = buildCriterionColors();      renderStackedChart(area, contrib, critColors);      // Legend      const lg = el('#legend');      lg.innerHTML = '';      for (const c of state.criteria) {        const col = critColors[c.id] || '#888';        const item = document.createElement('div');        item.className = 'key';        item.innerHTML = `<span class="swatch" style="background:${col}"></span> ${escapeHtml(c.name||'')}`;        lg.appendChild(item);      }    }  }  function renderTotalChart(container, rows) {    const W = container.clientWidth || 1000;    const H = Math.max(160, 46 * rows.length + 40);    const padL = 160, padR = 40, padT = 20, padB = 30;    const innerW = Math.max(200, W - padL - padR);    const innerH = H - padT - padB;    const rowH = Math.max(24, Math.floor(innerH / Math.max(1, rows.length)));    const maxAbs = Math.max(10, ...rows.map(r => Math.abs(r.score)));    const domMin = -maxAbs, domMax = maxAbs;    const xScale = (v) => padL + ( (v - domMin) / (domMax - domMin) ) * innerW;    const yFor = (i) => padT + i * rowH;    const svg = createSvg(W, H);    // Zero line    const x0 = xScale(0);    svg.appendChild(line(x0, padT, x0, padT+innerH, '#556'));    // Axis labels    svg.appendChild(textNode(padL-10, padT-6, 'Optionen', 'end', '#8ea0c7'));    svg.appendChild(textNode(W - padR, H - 8, 'Score (‚àí10 ‚Ä¶ +10)', 'end', '#8ea0c7'));    rows.forEach((r, i) => {      const y = yFor(i) + 6;      // name      svg.appendChild(textNode(padL - 12, y + 12, r.name, 'end', '#cfd8ff', 13));      // bar      const xStart = xScale(Math.min(0, r.score));      const xEnd   = xScale(Math.max(0, r.score));      const bw = Math.max(1, xEnd - xStart);      const col = r.score >= 0 ? '#22c55e' : '#ef4444';      const rect = rectNode(xStart, y, bw, rowH - 12, col, 4);      rect.appendChild(titleNode(`Score: ${r.score.toFixed(3)}`));      svg.appendChild(rect);      // value label      const lx = r.score >= 0 ? xEnd + 6 : xStart - 6;      const anchor = r.score >= 0 ? 'start' : 'end';      svg.appendChild(textNode(lx, y + (rowH-12)/2 + 6, r.score.toFixed(3), anchor, '#aab6e8', 12));    });    container.appendChild(svg);  }  function renderStackedChart(container, contrib, critColors) {    const rows = state.options.map(o => ({      id: o.id, name: o.name||'Option', contributions: (contrib[o.id]||[]).map(x => ({ ...x }))    }));    // Determine max span (sum of positive, sum of negative) to set symmetrical domain    let maxPos = 0, maxNeg = 0;    rows.forEach(r => {      const pos = r.contributions.filter(c => c.value > 0).reduce((a,b)=>a+b.value, 0);      const neg = r.contributions.filter(c => c.value < 0).reduce((a,b)=>a+Math.abs(b.value), 0);      maxPos = Math.max(maxPos, pos);      maxNeg = Math.max(maxNeg, neg);    });    const maxAbs = Math.max(10, maxPos, maxNeg);    const W = container.clientWidth || 1000;    const H = Math.max(200, 50 * rows.length + 40);    const padL = 160, padR = 40, padT = 20, padB = 30;    const innerW = Math.max(200, W - padL - padR);    const innerH = H - padT - padB;    const rowH = Math.max(24, Math.floor(innerH / Math.max(1, rows.length)));    const domMin = -maxAbs, domMax = maxAbs;    const xScale = (v) => padL + ( (v - domMin) / (domMax - domMin) ) * innerW;    const yFor = (i) => padT + i * rowH;    const svg = createSvg(W, H);    const x0 = xScale(0);    svg.appendChild(line(x0, padT, x0, padT+innerH, '#556'));    // Axis label    svg.appendChild(textNode(padL-10, padT-6, 'Optionen', 'end', '#8ea0c7'));    svg.appendChild(textNode(W - padR, H - 8, 'Beitr√§ge je Kriterium (Summe = Score)', 'end', '#8ea0c7'));    rows.forEach((r, i) => {      const y = yFor(i) + 6;      svg.appendChild(textNode(padL - 12, y + 12, r.name, 'end', '#cfd8ff', 13));      // Positive stack to the right, negative to the left      let accPos = 0;      let accNeg = 0;      // Draw negatives (left, starting from 0 going left)      r.contributions.filter(c => c.value < 0).forEach(c => {        const start = -accNeg;        const next = start + c.value; // c.value negative        const xStart = xScale(next);        const xEnd   = xScale(start);        const w = Math.max(1, xEnd - xStart);        accNeg += Math.abs(c.value);        const col = shade(critColors[c.criterionId] || '#888', 0.7); // darker for negative        const rc = rectNode(xStart, y, w, rowH-12, col, 4);        rc.appendChild(titleNode(`${criterionName(c.criterionId)}: ${c.value.toFixed(3)}`));        svg.appendChild(rc);      });      // Draw positives (right)      r.contributions.filter(c => c.value >= 0).forEach(c => {        const start = accPos;        const next = start + c.value;        const xStart = xScale(start);        const xEnd = xScale(next);        const w = Math.max(1, xEnd - xStart);        accPos += c.value;        const col = critColors[c.criterionId] || '#88c';        const rc = rectNode(xStart, y, w, rowH-12, col, 4);        rc.appendChild(titleNode(`${criterionName(c.criterionId)}: ${c.value.toFixed(3)}`));        svg.appendChild(rc);      });      // Value label total      const total = r.contributions.reduce((a,b)=>a+b.value,0);      const lx = total >= 0 ? xScale(total) + 6 : xScale(total) - 6;      const anchor = total >= 0 ? 'start' : 'end';      svg.appendChild(textNode(lx, y + (rowH-12)/2 + 6, total.toFixed(3), anchor, '#aab6e8', 12));    });    container.appendChild(svg);  }  function buildCriterionColors() {    // Distinct palette    const base = [      '#5bc0de', '#88e0a7', '#f6c945', '#f78fb3', '#c792ea', '#82aaff', '#7fdbca', '#ffad60', '#b8e986', '#ffa8a8',      '#ffd166', '#06d6a0', '#00bcd4', '#a29bfe', '#b2f7ef', '#fddb3a', '#ff99c8', '#a8dadc', '#f4a261', '#90be6d'    ];    const res = {};    state.criteria.forEach((c, i) => { res[c.id] = base[i % base.length]; });    return res;  }  function criterionName(id) {    const c = state.criteria.find(x => x.id === id);    return c ? c.name || 'Kriterium' : 'Kriterium';  }  // SVG helpers  function createSvg(w,h){ const s=document.createElementNS('http://www.w3.org/2000/svg','svg'); s.setAttribute('width', w); s.setAttribute('height', h); s.setAttribute('viewBox', `0 0 ${w} ${h}`); s.style.width='100%'; s.style.height='auto'; return s; }  function rectNode(x,y,w,h,fill,r=0){ const n = document.createElementNS('http://www.w3.org/2000/svg','rect'); n.setAttribute('x',x); n.setAttribute('y',y); n.setAttribute('width',w); n.setAttribute('height',h); if(r){n.setAttribute('rx',r); n.setAttribute('ry',r);} n.setAttribute('fill',fill); n.setAttribute('stroke','#0b0f1c'); n.setAttribute('stroke-width','0.5'); return n; }  function line(x1,y1,x2,y2,stroke='#667',sw=1){ const n = document.createElementNS('http://www.w3.org/2000/svg','line'); n.setAttribute('x1',x1); n.setAttribute('y1',y1); n.setAttribute('x2',x2); n.setAttribute('y2',y2); n.setAttribute('stroke',stroke); n.setAttribute('stroke-width',sw); return n; }  function textNode(x,y,txt,anchor='start',fill='#ccd',size=12){ const n = document.createElementNS('http://www.w3.org/2000/svg','text'); n.setAttribute('x',x); n.setAttribute('y',y); n.setAttribute('fill',fill); n.setAttribute('font-size',size); n.setAttribute('text-anchor',anchor); n.setAttribute('dominant-baseline','middle'); n.textContent = txt; return n; }  function titleNode(txt){ const t = document.createElementNS('http://www.w3.org/2000/svg','title'); t.textContent = txt; return t; }  function shade(hex, factor=0.8){ // darken    const c = hex.replace('#','');    const r = Math.max(0, Math.min(255, Math.round(parseInt(c.slice(0,2),16)*factor)));    const g = Math.max(0, Math.min(255, Math.round(parseInt(c.slice(2,4),16)*factor)));    const b = Math.max(0, Math.min(255, Math.round(parseInt(c.slice(4,6),16)*factor)));    return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;  }  /** ---- Events ---- **/  // Header actions  el('#btn-reset').addEventListener('click', () => {    if (!confirm('Wirklich alles zur√ºcksetzen und neu beginnen?')) return;    snapshot();    state = { criteria: [], options: [], ratings: {}, ui: { step: 1, chartTab:'total' }, meta: { version: 1 } };    saveState(); renderAll();  });  el('#btn-export').addEventListener('click', doExport);  el('#btn-export-2').addEventListener('click', doExport);  el('#file-import').addEventListener('change', handleImportFile);  el('#btn-print').addEventListener('click', () => window.print());  el('#btn-undo').addEventListener('click', undo);  // Stepper click  el('#stepper').addEventListener('click', (e) => {    const stepEl = e.target.closest('.step');    if (!stepEl) return;    const step = Number(stepEl.getAttribute('data-step'));    if (canGoTo(step)) gotoStep(step);  });  // Step 1 Add  function addCriterionFromInputs() {    const name = (el('#crit-name').value || '').trim();    const desc = (el('#crit-desc').value || '').trim();    if (!name) { alert('Bitte einen Kriteriennamen eingeben.'); return; }    snapshot();    const id = genId('c');    state.criteria.push({ id, name, description: desc, weight: 0 });    ensureRatingsForCriterion(id);    el('#crit-name').value = '';    // Beschreibung optional wahlweise behalten oder leeren; hier leeren wenn STRG+Enter    el('#crit-desc').value = '';    saveState(); renderAll();  }  el('#add-crit').addEventListener('click', addCriterionFromInputs);  el('#crit-name').addEventListener('keydown', (e) => {    if (e.key === 'Enter' && !e.ctrlKey) { addCriterionFromInputs(); }    if (e.key === 'Enter' && e.ctrlKey) { addCriterionFromInputs(); }  });  el('#crit-desc').addEventListener('keydown', (e) => {    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { addCriterionFromInputs(); }  });  // Step 1 list handlers (edit/delete)  el('#step-1').addEventListener('input', (e) => {    const nameInput = e.target.closest('.crit-name');    const descInput = e.target.closest('.crit-desc');    if (nameInput) {      const id = nameInput.getAttribute('data-id');      const c = state.criteria.find(x => x.id === id);      if (!c) return;      c.name = nameInput.value;      saveState();    } else if (descInput) {      const id = descInput.getAttribute('data-id');      const c = state.criteria.find(x => x.id === id);      if (!c) return;      c.description = descInput.value;      saveState();    }  });  el('#step-1').addEventListener('click', (e) => {    const del = e.target.closest('.del-crit');    if (del) {      const id = del.getAttribute('data-id');      const c = state.criteria.find(x => x.id === id);      if (!c) return;      if (!confirm(`Kriterium ‚Äû${c.name}‚Äú l√∂schen?`)) return;      snapshot();      state.criteria = state.criteria.filter(x => x.id !== id);      removeCriterionEverywhere(id);      saveState(); renderAll();    }  });  // Navigation buttons  el('#to-2').addEventListener('click', () => gotoStep(2));  el('#back-1').addEventListener('click', () => gotoStep(1));  el('#to-3').addEventListener('click', () => gotoStep(3));  el('#back-2').addEventListener('click', () => gotoStep(2));  el('#to-4').addEventListener('click', () => gotoStep(4));  el('#back-3').addEventListener('click', () => gotoStep(3));  el('#to-5').addEventListener('click', () => gotoStep(5));  el('#to-5-top').addEventListener('click', () => gotoStep(5));  el('#back-4').addEventListener('click', () => gotoStep(4));  el('#goto-weights').addEventListener('click', () => gotoStep(2));  el('#goto-options').addEventListener('click', () => gotoStep(3));  // Step 2 interactions  el('#weights-list').addEventListener('input', (e) => {    const rs = e.target.closest('.w-slider');    const ri = e.target.closest('.w-input');    if (rs || ri) {      const id = (rs || ri).getAttribute('data-id');      const c = state.criteria.find(x => x.id === id);      if (!c) return;      let val = Number((rs || ri).value);      if (isNaN(val)) val = 0;      val = clip(val, -10, 10);      snapshot();      c.weight = val;      // reflect to both controls      const row = (rs || ri).closest('.item');      if (row) {        const s = row.querySelector('.w-slider'); const n = row.querySelector('.w-input');        if (s) s.value = val; if (n) n.value = val;      }      el('#sumW').textContent = String(sumAbsWeights().toFixed(0));      saveState();    }  });  el('#weights-list').addEventListener('click', (e) => {    const zeroBtn = e.target.closest('[data-action="w-zero"]');    if (zeroBtn) {      const id = zeroBtn.getAttribute('data-id');      const c = state.criteria.find(x => x.id === id);      if (!c) return;      snapshot();      c.weight = 0;      saveState(); renderAll();      return;    }    const del = e.target.closest('.del-crit');    if (del) {      const id = del.getAttribute('data-id');      const c = state.criteria.find(x => x.id === id);      if (!c) return;      if (!confirm(`Kriterium ‚Äû${c.name}‚Äú l√∂schen?`)) return;      snapshot();      state.criteria = state.criteria.filter(x => x.id !== id);      removeCriterionEverywhere(id);      saveState(); renderAll();    }  });  el('#weights-zero').addEventListener('click', () => {    if (state.criteria.length === 0) return;    snapshot();    state.criteria.forEach(c => c.weight = 0);    saveState(); renderAll();  });  // Step 3 options  function addOptionFromInput() {    const name = (el('#opt-name').value || '').trim();    if (!name) { alert('Bitte einen Optionsnamen eingeben.'); return; }    snapshot();    const id = genId('o');    state.options.push({ id, name });    ensureRatingsForOption(id);    el('#opt-name').value = '';    saveState(); renderAll();  }  el('#add-opt').addEventListener('click', addOptionFromInput);  el('#opt-name').addEventListener('keydown', (e) => {    if (e.key === 'Enter') addOptionFromInput();  });  el('#step-3').addEventListener('input', (e) => {    const inp = e.target.closest('.opt-name');    if (!inp) return;    const id = inp.getAttribute('data-id');    const o = state.options.find(x => x.id === id);    if (!o) return;    o.name = inp.value;    saveState();  });  el('#step-3').addEventListener('click', (e) => {    const del = e.target.closest('.del-opt');    if (!del) return;    const id = del.getAttribute('data-id');    const o = state.options.find(x => x.id === id);    if (!o) return;    if (!confirm(`Option ‚Äû${o.name}‚Äú l√∂schen?`)) return;    snapshot();    state.options = state.options.filter(x => x.id !== id);    removeOptionEverywhere(id);    saveState(); renderAll();  });  // Step 4 ratings  el('#ratings-grid').addEventListener('input', (e) => {    const rs = e.target.closest('.r-slider');    const ri = e.target.closest('.r-input');    if (!rs && !ri) return;    const oid = (rs||ri).getAttribute('data-oid');    const cid = (rs||ri).getAttribute('data-cid');    if (!state.ratings[oid]) state.ratings[oid] = {};    let val = Number((rs||ri).value);    if (isNaN(val)) val = 0;    val = clip(val, -10, 10);    snapshot();    state.ratings[oid][cid] = val;    // sync both    const card = (rs||ri).closest('.line');    if (card) {      const s = card.querySelector('.r-slider'); const n = card.querySelector('.r-input');      if (s) s.value = val; if (n) n.value = val;    }    saveState();  });  el('#ratings-grid').addEventListener('click', (e) => {    const zero = e.target.closest('[data-action="opt-zero"]');    if (zero) {      const oid = zero.getAttribute('data-id');      snapshot();      for (const c of state.criteria) {        if (!state.ratings[oid]) state.ratings[oid] = {};        state.ratings[oid][c.id] = 0;      }      saveState(); renderAll();      return;    }    const del = e.target.closest('.del-opt');    if (del) {      const id = del.getAttribute('data-id');      const o = state.options.find(x => x.id === id);      if (!o) return;      if (!confirm(`Option ‚Äû${o.name}‚Äú l√∂schen?`)) return;      snapshot();      state.options = state.options.filter(x => x.id !== id);      removeOptionEverywhere(id);      saveState(); renderAll();    }  });  el('#ratings-zero').addEventListener('click', () => {    if (state.options.length === 0 || state.criteria.length === 0) return;    snapshot();    for (const o of state.options) {      if (!state.ratings[o.id]) state.ratings[o.id] = {};      for (const c of state.criteria) {        state.ratings[o.id][c.id] = 0;      }    }    saveState(); renderAll();  });  // Charts tabs  els('.tab').forEach(t => {    t.addEventListener('click', () => {      els('.tab').forEach(x => x.classList.remove('active'));      t.classList.add('active');      state.ui.chartTab = t.getAttribute('data-tab');      saveState();      renderCharts();    });  });  // Export/Import helpers  function doExport() {    const data = JSON.stringify(state, null, 2);    const blob = new Blob([data], { type: 'application/json' });    const url = URL.createObjectURL(blob);    const a = document.createElement('a');    const ts = new Date().toISOString().replace(/[:.]/g, '-');    a.href = url;    a.download = `easy-decision-sven-${ts}.json`;    document.body.appendChild(a);    a.click();    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);  }  function handleImportFile(e) {    const file = e.target.files && e.target.files[0];    if (!file) return;    const reader = new FileReader();    reader.onload = () => {      try {        const parsed = JSON.parse(reader.result);        if (!parsed || !parsed.meta) { alert('Ung√ºltige Datei.'); return; }        snapshot();        state = parsed;        saveState(); renderAll();        alert('Import erfolgreich geladen.');      } catch(err) {        alert('Konnte JSON nicht lesen: ' + err.message);      }    };    reader.readAsText(file);    // reset input so same file can be selected again    e.target.value = '';  }  // Helpers  function clip(v, min, max){ return Math.max(min, Math.min(max, v)); }  function escapeHtml(str) {    return String(str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));  }  /** ---- Init ---- **/  (function init(){    // load existing state if present    loadState();    // Ensure ratings integrity    for (const o of state.options) ensureRatingsForOption(o.id);    for (const c of state.criteria) ensureRatingsForCriterion(c.id);    // Initial render    renderAll();  })();})();</script></body></html>
